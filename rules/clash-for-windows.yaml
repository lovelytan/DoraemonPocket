parsers: # array
  - reg: ^.+$
    code: |
      module.exports.parse = async (raw, { axios, yaml, notify, console }, { name, url, interval, selected }) => {
        const params = yaml.parse(raw);
      
        const { proxies } = params

        const dns = {
          enable: true,
          ipv6: true,
          'use-hosts': true,
          'enhanced-mode': 'fake-ip',    
          'fake-ip-range': '198.18.0.1/16',
          'fake-ip-filter': [
            '*.lan',
            '*.localdomain',
            '*.localhost',
            '*.test',
            '*.local',
            '*.qq.com'
          ],
          'default-nameserver': [
            '223.5.5.5',
            '119.29.29.29'
          ],
          nameserver: [
            '223.5.5.5',
            '119.29.29.29',
            'tls://223.5.5.5:853'
          ],
          fallback: [
            'https://1.0.0.1/dns-query',
            'https://doh.dns.sb/dns-query',
            'https://dns.cloudflare.com/dns-query',
            'https://dns.google/dns-query',
            'https://dns.twnic.tw/dns-query',
            'https://dns.quad9.net/dns-query',
            'tls://8.8.4.4:853'
          ],
          'fallback-filter': {
            geoip: true,
            'geoip-code': 'CN',
            ipcidr: ['240.0.0.0/4', '0.0.0.0/32']
          }
        }

        const regionsList = {
          'ğŸ‡­ğŸ‡° é¦™æ¸¯èŠ‚ç‚¹': { reg: /^(?!.*æ¸¸æˆ).*(é¦™æ¸¯|ğŸ‡­ğŸ‡°|HongKong|HK)+(.*)$/ },
          'ğŸ‡¨ğŸ‡³ å°æ¹¾èŠ‚ç‚¹': { reg: /^(?!.*æ¸¸æˆ).*(å°æ¹¾|ğŸ‡¨ğŸ‡³|Taiwan|TW)+(.*)$/ },
          'ğŸ‡¯ğŸ‡µ æ—¥æœ¬èŠ‚ç‚¹': { reg: /^(?!.*æ¸¸æˆ).*(æ—¥æœ¬|ğŸ‡¯ğŸ‡µ|Japan|JP|ä¸œäº¬)+(.*)$/ },
          'ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡èŠ‚ç‚¹': { reg: /^(?!.*æ¸¸æˆ).*(æ–°åŠ å¡|ğŸ‡¸ğŸ‡¬|Singapore|SG|ç‹®åŸ)+(.*)$/ },
          'ğŸ‡°ğŸ‡· éŸ©å›½èŠ‚ç‚¹': { reg: /^(?!.*æ¸¸æˆ).*(éŸ©å›½|ğŸ‡°ğŸ‡·|Korea|Kr)+(.*)/ },
          'ğŸ‡ºğŸ‡² ç¾å›½èŠ‚ç‚¹': { reg: /^(?!.*æ¸¸æˆ).*(ç¾å›½|ğŸ‡ºğŸ‡¸|American|US)+(.*)$/ },
          'ğŸ³ï¸â€ğŸŒˆ å…¶ä»–åœ°åŒº': { reg: /^(?!.*æ¸¸æˆ).*/ }
        }
        const customProxies = {
          lowRate: { reg: /(?<![0-9])0\.[0-9]+|ä½å€/ },
          ai: { reg: /^(?!.*æ¸¸æˆ).*(æ™ºèƒ½|ai|gpt)+(.*)/i },
          download: { reg: /^(?!.*æ¸¸æˆ).*(ä¸‹è½½|Download|p2p|bt|(?<![0-9])0\.[0-9]+)+(.*)/i }
        }
        proxies.forEach(proxy => {
          for (let key in regionsList) {
            const region = regionsList[key]
            !region.proxies && (region.proxies = [])
            if (region.reg.test(proxy.name)) {
              region.proxies.push(proxy.name)
              break
            }
          }

          for (let key in customProxies) {
            const custom = customProxies[key]
            !custom.proxies && (custom.proxies = [])
            custom.reg.test(proxy.name) && custom.proxies.push(proxy.name)
          }
        })
        const regionProxyGroups = Object.keys(regionsList).reduce((res, key) => {
          const { type = 'url-test', proxies } = regionsList[key]
          if (regionsList[key].proxies?.length) {
            res.push({
              name: key,
              type: type,
              url: 'http://www.gstatic.com/generate_204',
              interval: 300,
              tolerance: 50,
              proxies: proxies
            })
          }
          return res
        }, [])
        const regionProxyGroupNames = regionProxyGroups.map(regionProxyGroup => regionProxyGroup.name)

        const proxyGroups = [
          { name: 'ğŸš€ èŠ‚ç‚¹é€‰æ‹©', type: 'select', proxies: ['ğŸ—º åœ°åŒºèŠ‚ç‚¹', 'ğŸ­ ä½å€èŠ‚ç‚¹', 'DIRECT', ...proxies.map(item => item.name)] },
          { name: 'ğŸ—º åœ°åŒºèŠ‚ç‚¹', type: 'select', proxies: regionProxyGroupNames },
          {
            name: 'ğŸ­ ä½å€èŠ‚ç‚¹',
            type: 'select',
            proxies: [...customProxies.lowRate.proxies, 'DIRECT']
          },
          {
            name: 'â¬‡ï¸ ä¸‹è½½èŠ‚ç‚¹',
            type: 'select',
            proxies: [...customProxies.download.proxies, ...regionProxyGroupNames, 'DIRECT']
          },
          {
            name: 'ğŸ’¬ äººå·¥æ™ºèƒ½',
            type: 'select',
            proxies: [...customProxies.ai.proxies, ...regionProxyGroupNames, 'DIRECT']
          },
          { name: 'ğŸ® æ¸¸æˆå¹³å°', type: 'select', proxies: ['ğŸš€ èŠ‚ç‚¹é€‰æ‹©', 'DIRECT'] },
          ...regionProxyGroups,
          { name: 'ğŸŸ æ¼ç½‘ä¹‹é±¼', type: 'select', proxies: ['ğŸš€ èŠ‚ç‚¹é€‰æ‹©', 'DIRECT'] },
          { name: 'ğŸ›‘ å…¨çƒæ‹¦æˆª', type: 'select', proxies: ['REJECT', 'DIRECT'] }
        ]
        const providers = {
          Direct: {
            type: 'http',
            behavior: 'classical',
            url: 'https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Direct/Direct.yaml',
            format: 'yaml',
            interval: 86400,
            path: './ruleset/Direct.yaml'
          },
          Lan: {
            type: 'http',
            behavior: 'classical',
            url: 'https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Providers/LocalAreaNetwork.yaml',
            format: 'yaml',
            path: './ruleset/Lan.yaml',
            interval: 86400
          },
          Apple: {
            type: 'http',
            behavior: 'classical',
            url: 'https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Providers/Apple.yaml',
            format: 'yaml',
            path: './ruleset/Apple.yaml',
            interval: 86400
          },
          Microsoft: {
            type: 'http',
            behavior: 'classical',
            url: 'https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Providers/Ruleset/Microsoft.yaml',
            format: 'yaml',
            path: './ruleset/Microsoft.yaml',
            interval: 86400
          },
          Game: {
            type: 'http',
            behavior: 'classical',
            url: 'https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Game/Game.yaml',
            format: 'yaml',
            path: './ruleset/Game.yaml',
            interval: 86400
          },
          Download: {
            type: 'http',
            behavior: 'classical',
            url: 'https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Download/Download.yaml',
            format: 'yaml',
            path: './ruleset/Download.yaml',
            interval: 86400
          },
          OpenAI: {
            type: 'http',
            behavior: 'classical',
            url: 'https://raw.githubusercontent.com/ericz15/ios_rule_script/master/rule/Clash/OpenAI/OpenAI.yaml',
            format: 'yaml',
            path: './ruleset/OpenAI.yaml',
            interval: 86400
          },
          Claude: {
            type: 'http',
            behavior: 'classical',
            url: 'https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Claude/Claude.yaml',
            format: 'yaml',
            path: './ruleset/Claude.yaml',
            interval: 86400
          },
          Google: {
            type: 'http',
            behavior: 'classical',
            url: 'https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Providers/Ruleset/Google.yaml',
            format: 'yaml',
            path: './ruleset/Google.yaml',
            interval: '86400'
          },
          Telegram: {
            type: 'http',
            behavior: 'classical',
            url: 'https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Providers/Ruleset/Telegram.yaml',
            format: 'yaml',
            path: './ruleset/Telegram.yaml',
            interval: 86400
          },
          GFW: {
            type: 'http',
            behavior: 'domain',
            url: 'https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/gfw.txt',
            path: './ruleset/GFW.yaml',
            interval: '86400'
          },
          ChinaIP: {
            type: 'http',
            behavior: 'ipcidr',
            url: 'https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/cncidr.txt',
            path: './ruleset/ChinaIP.yaml',
            interval: 8640
          }
        }
        const rules = [
          'DOMAIN-SUFFIX,ysepan.com,ğŸš€ èŠ‚ç‚¹é€‰æ‹©',
          'DOMAIN-SUFFIX,ys168.com,ğŸš€ èŠ‚ç‚¹é€‰æ‹©',
          'DOMAIN-SUFFIX,staticfile.net,ğŸš€ èŠ‚ç‚¹é€‰æ‹©',
          'DOMAIN-SUFFIX,jianguoyun.com,ğŸš€ èŠ‚ç‚¹é€‰æ‹©',
          'DOMAIN-SUFFIX,storage.googleapis.com,â¬‡ï¸ ä¸‹è½½èŠ‚ç‚¹',
          'DOMAIN-SUFFIX,production.cloudflare.docker.com,â¬‡ï¸ ä¸‹è½½èŠ‚ç‚¹',
          'DOMAIN-SUFFIX,download-cdn.jetbrains.com,â¬‡ï¸ ä¸‹è½½èŠ‚ç‚¹',
          'DOMAIN-SUFFIX,bard.google.com,ğŸ’¬ äººå·¥æ™ºèƒ½',
          'RULE-SET,Direct,DIRECT',
          'RULE-SET,Lan,DIRECT',
          'RULE-SET,Download,DIRECT',
          'RULE-SET,OpenAI,ğŸ’¬ äººå·¥æ™ºèƒ½',
          'RULE-SET,Claude,ğŸ’¬ äººå·¥æ™ºèƒ½',
          'RULE-SET,Game,ğŸ® æ¸¸æˆå¹³å°',
          'RULE-SET,Apple,DIRECT',
          'RULE-SET,Microsoft,DIRECT',
          'RULE-SET,Google,ğŸš€ èŠ‚ç‚¹é€‰æ‹©',
          'RULE-SET,Telegram,ğŸš€ èŠ‚ç‚¹é€‰æ‹©',
          'RULE-SET,GFW,ğŸš€ èŠ‚ç‚¹é€‰æ‹©',
          'RULE-SET,ChinaIP,DIRECT,no-resolve',
          'GEOIP,CN,DIRECT,no-resolve',
          'MATCH,ğŸŸ æ¼ç½‘ä¹‹é±¼'
        ]

        params['dns'] = dns
        params['proxy-groups'] = proxyGroups
        params['rule-providers'] = providers
        params['rules'] = rules
      
        return yaml.stringify(params)
      }
